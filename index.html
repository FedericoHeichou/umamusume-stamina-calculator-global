<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Advanced Stamina Calculator for Uma Musume. Calculate target stats based on track, strategy, and skills.">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <title>Umamusume Stamina Calculator - Global</title>
    <style>
        :root { --uma-pink: #ff6b81; --uma-blue: #74b9ff; --uma-green: #2ecc71; --dark: #2d3436; --gray: #636e72; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: var(--dark); font-size: 14px; }
        .card { max-width: 1100px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); padding: 25px; }
        h1 { text-align: center; color: var(--uma-pink); margin-bottom: 30px; }
        .row { display: grid; gap: 15px; margin-bottom: 25px; align-items: end; }
        .col-5 { grid-template-columns: repeat(5, 1fr); }
        .col-4 { grid-template-columns: repeat(4, 1fr); }
        .col-3 { grid-template-columns: repeat(3, 1fr); }
        .col-2 { grid-template-columns: repeat(2, 1fr); }
        .text-center { text-align: center; }
        .no-transition, .no-transition::before, .no-transition::after { transition: none !important; }
        .skills-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 18px 30px; margin-bottom: 25px; }
        .skill-box { display: flex; align-items: center; background: #f8f9fa; border-radius: 8px; padding: 10px 16px; gap: 14px; min-height: 36px; }
        .skill-icon { width: 32px; height: 32px; object-fit: contain; border-radius: 6px; background: #fff; border: 1px solid #e1e1e1; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
        .skill-label { font-weight: bold; font-size: 1rem; color: var(--uma-pink); min-width: 110px; }
        .recovery-percent, .bonus-value { color: var(--gray); font-size: 0.9em; font-weight: normal; margin-left: 2px; }
        .skill-tooltip-icon { display: inline-block; width: 18px; height: 18px; margin-left: 6px; vertical-align: middle; border-radius: 50%; background: #ff6b81; color: #fff; font-weight: bold; font-size: 1rem; text-align: center; line-height: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); cursor: pointer; position: relative; border: 1px solid #ff6b81; }
        .skill-tooltip-icon:hover + .skill-tooltip{ opacity: 1; pointer-events: auto; }
        .skill-tooltip { opacity: 0; transition: opacity 0.2s; position: absolute; left: 50%; top: 120%; transform: translateX(-50%); background: #fff; color: #2d3436; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); padding: 12px 16px; font-size:0.85rem; min-width: 220px; z-index: 20; pointer-events: none; }
        .skill-tooltip strong{ color:var(--uma-pink); }
        .skill-tooltip span{ color:#636e72; font-size:0.8em; }
        .skill-tooltip ul { margin: 6px 0 0 0; padding-left: 18px; color: #636e72; font-size: 0.8em; }
        .skill-tooltip ul li { margin-bottom: 2px; }
        .skill-box{ position:relative; }
        .stepper-group { display: flex; align-items: center; margin-left: auto; }
        .stepper-btn { width: 28px; height: 32px; font-size: 1.2rem; border: none; background: #e1e1e1; color: #636e72; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .stepper-btn:hover { background: #dfe6e9; }
        .skill-stepper-label { width: 38px; text-align: center; font-size: 1rem; border: none; background: transparent; font-weight: bold; color: var(--dark); pointer-events: none; margin: 0 4px; }
        .recovery-level { margin-right: 10px; padding: 6px 8px; border-radius: 6px; border: 1px solid #dfe6e9; font-size: 1rem; }

        .section-label { font-size: 0.75rem; font-weight: bold; color: var(--uma-pink); text-transform: uppercase; border-bottom: 2px solid #eee; margin-bottom: 10px; padding-bottom: 3px; cursor: pointer; display: flex; align-items: center; user-select: none; justify-content: flex-start; }
        .section-arrow { width: 32px; min-width: 32px; max-width: 32px; height: 32px; margin-left: auto; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f8f9fa; color: var(--gray); font-size: 1.2em; transition: background 0.15s, color 0.15s; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
        .section-label:hover .section-arrow { background: #e1e1e1; color: var(--uma-pink); }
        input.section-toggle { display: none; }
        .section-label .section-arrow { order: 2; }
        .section-label .section-title { order: 1; flex-grow: 1 ; min-width: 0; }
        .section-label .section-arrow::before { content: '\203a'; font-size: 1.5em; transition: transform 0.2s; display: block; transform: rotate(90deg) translateY(-1px); }
        input.section-toggle:checked + .section-label .section-arrow::before { content: '\2039'; }
        input.section-toggle:not(:checked) + .section-label + .section-content { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s cubic-bezier(.4,0,.2,1), opacity 0.2s; }
        input.section-toggle:checked + .section-label + .section-content { max-height: 2000px; opacity: 1; overflow: visible; transition: max-height 0.5s cubic-bezier(.4,0,.2,1), opacity 0.3s; }
        .section-content { max-height: 2000px; opacity: 1; overflow: visible; transition: max-height 0.5s cubic-bezier(.4,0,.2,1), opacity 0.3s; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-weight: bold; font-size: 0.8rem; color: var(--gray); }
        input, select { padding: 8px; border: 1px solid #dfe6e9; border-radius: 6px; font-size: 0.9rem; }

        .results-area { background: #2d3436; color: white; border-radius: 10px; padding: 20px; margin-top: 20px; }
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        .res-box h3 { font-size: 0.7rem; color: #b2bec3; margin: 5px; }
        .res-val { font-size: 1.8rem; font-weight: bold; color: var(--uma-blue); display: block; margin-top: 5px; }

        .tooltip { position: relative; cursor: help; border-bottom: 1px dotted #777; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 300px; background: #555; color: #fff; padding: 10px; border-radius: 6px;
            position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%);
            font-size: 0.75rem; white-space: pre-wrap; opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .target-container { grid-column: 1 / -1; border-top: 1px solid #444; margin-top: 20px; padding-top: 20px; text-align: center; }
        .target-container h3 { font-size: 1rem; margin: 8px; }
        .target-val { font-size: 3.5rem; color: var(--uma-green); font-weight: bold; }

        .calculated-stats-area { background: linear-gradient(90deg, #f6fafd 60%, #eaf6fb 100%); border-radius: 10px; box-shadow: 0 2px 10px rgba(116,185,255,0.07); padding: 18px 10px 10px 10px; margin-bottom: 18px; }
        .calculated-stats-area > div:first-child { font-weight: bold; color: var(--uma-pink); font-size: 1.1rem; margin-bottom: 8px; }
        .calculated-stats-row { display: flex; gap: 32px; justify-content: center; align-items: flex-end; }
        .calculated-stats-row > div { text-align: center; }
        .calculated-stats-row .stat-label { font-size: 0.9rem; margin-bottom: 4px; }
        .calculated-stats-row img { width: 36px; height: 36px; margin-bottom: 4px; }
        .calculated-stats-row .stat-value { font-size: 1.1rem; font-weight: bold; margin-top: 2px; }
        #stat-adjSpd { color: #27b2ff; }
        #stat-adjStam { color: #fe7f6f; }
        #stat-adjPwr { color: #ffad13; }
        #stat-adjGuts { color: #fe84ad; }
        #stat-adjWit { color: #1dd29e; }

        .footer { margin-top: 40px; padding: 20px; text-align: center; font-size: 0.85rem; color: var(--gray); border-top: 1px solid #dfe6e9; line-height: 1.5; }
        .footer a { color: var(--uma-pink); text-decoration: none; font-weight: bold; transition: opacity 0.2s; }
        .footer a:hover { text-decoration: underline; opacity: 0.8; }

        *[data-rank="S"] { color: #f1c40f !important; font-weight: bold; }
        *[data-rank="A"] { color: #e67e22 !important; font-weight: bold; }
        *[data-rank="B"] { color: #e74c3c !important; font-weight: bold; }
        *[data-rank="C"] { color: #2ecc71 !important; font-weight: bold; }
        *[data-rank="D"] { color: #3498db !important; font-weight: bold; }
        *[data-rank="E"] { color: #ff79c6 !important; font-weight: bold; }
        *[data-rank="F"] { color: #9b59b6 !important; font-weight: bold; }
        *[data-rank="G"] { color: #95a5a6 !important; font-weight: bold; }
        select, select option { background: white; }

        @media (max-width: 768px) {
            body { padding: 0; width: 100%; margin: 0; }
            .card { padding: 15px; }
            .col-5, .col-4, .col-3, .col-2 { grid-template-columns: 1fr; gap: 10px; }
            .res-grid { grid-template-columns: 1fr; gap: 20px; }
            .res-val { font-size: 1.5rem; }
            .target-val { font-size: 2.5rem; }
            .tooltip .tooltiptext { width: 250px; left: 50%; transform: translateX(-50%); }
            input { font-size: 16px; width: calc(100% - 20px); }
            select { font-size: 16px; width: calc(100% - 2px); }
            .skills-grid { grid-template-columns: 1fr; gap: 12px; }
            .skill-box { flex-direction: row; gap: 10px; }
            .skill-label { min-width: 35px; font-size: 0.95rem; }
            .skill-stepper-label { padding: 0; width: 20px; }
            .recovery-level { min-width: 30px; }
            .d-s-none { display: none; }
            .section-label .section-arrow::before { transform: rotate(90deg) translateY(-2px); }
        }
    </style>
</head>
<body>

<div class="card">
    <h1>Umamusume Stamina Calculator - Global</h1>

    <input type="checkbox" id="section1" class="section-toggle" checked>
    <label for="section1" class="section-label"><span class="section-title">1. Character Statistics</span><span class="section-arrow"></span></label>
    <div class="section-content">
        <div class="row col-5">
            <div class="input-group"><label for="speed">Speed</label><input type="number" id="speed" value="1200"></div>
            <div class="input-group"><label for="stam">Stamina</label><input type="number" id="stam" value="900"></div>
            <div class="input-group"><label for="power">Power</label><input type="number" id="power" value="1200"></div>
            <div class="input-group"><label for="guts">Guts</label><input type="number" id="guts" value="600"></div>
            <div class="input-group"><label for="wit">Wit</label><input type="number" id="wit" value="1200"></div>
        </div>
    </div>

    <input type="checkbox" id="section2" class="section-toggle" checked>
    <label for="section2" class="section-label"><span class="section-title">2. Race Information</span><span class="section-arrow"></span></label>
    <div class="section-content">
        <div class="row col-4">
            <div class="input-group"><label for="dist">Distance (m)</label><input type="number" id="dist" value="2400"></div>
            <div class="input-group"><label for="surface">Track Surface</label><select id="surface"></select></div>
            <div class="input-group"><label for="condition">Track Condition</label><select id="condition"></select></div>
            <div class="input-group"><label for="mood">Mood</label><select id="mood"></select></div>
        </div>
    </div>

    <input type="checkbox" id="section3" class="section-toggle" checked>
    <label for="section3" class="section-label"><span class="section-title">3. Aptitude (Ranks)</span><span class="section-arrow"></span></label>
    <div class="section-content">
        <div class="row col-4">
            <div class="input-group"><label for="aptTrack">Track Aptitude</label><select id="aptTrack"></select></div>
            <div class="input-group"><label for="aptDist">Distance Aptitude</label><select id="aptDist"></select></div>
            <div class="input-group"><label for="style">Running Style</label><select id="style"></select></div>
            <div class="input-group"><label for="aptStyle">Style Aptitude</label><select id="aptStyle"></select></div>
        </div>
    </div>

    <input type="checkbox" id="section4" class="section-toggle" checked>
    <label for="section4" class="section-label"><span class="section-title">4. Recovery Skills</span><span class="section-arrow"></span></label>
    <div class="section-content">
        <div class="skills-grid">
            <div class="skill-box">
                <img src="img/recovery_gold.webp" alt="Gold Recovery Skills" class="skill-icon">
                <span class="skill-label">Gold <span class="recovery-percent">(5.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Gold Recovery Skills</strong><br><span>Gold skills restore 5.5% HP.<br>Examples:</span><ul>
                    <li>Swinging Maestro</li>
                    <li>Gourmand</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="goldRecoverySkill" data-step="-1">-</button>
                    <input type="text" id="goldRecoverySkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="goldRecoverySkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_normal.webp" alt="White Recovery Skills" class="skill-icon">
                <span class="skill-label">White <span class="recovery-percent">(1.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>White Recovery Skills</strong><br><span>White skills restore 1.5% HP.<br>Examples:</span><ul>
                    <li>Corner Recovery</li>
                    <li>Hydrate</li>
                    <li>Triple 7s</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="whiteRecoverySkill" data-step="-1">-</button>
                    <input type="text" id="whiteRecoverySkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="whiteRecoverySkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_unique.webp" alt="Unique 1.5% Recovery Skills" class="skill-icon">
                <img src="img/speed_unique.webp" alt="Unique 1.5% Recovery Skills" class="skill-icon d-s-none">
                <span class="skill-label">Unique 1.5% <span class="recovery-percent">(1.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Unique Recovery Skills 1.5%</strong><br><span>Restores 1.5% HP (+0.02% per level &gt; 1).<br>Examples:</span><ul>
                    <li>Operation Cacao</li>
                </ul></div></span>
                <div class="stepper-group">
                    <select id="uniqueLvl15" class="recovery-level"></select>
                    <div class="stepper-group">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill15" data-step="-1">-</button>
                        <input type="text" id="uniqueSkill15" value="0" readonly class="skill-stepper-label">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill15" data-step="1">+</button>
                    </div>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_unique.webp" alt="Unique 3.5% Recovery Skills" class="skill-icon">
                <img src="img/speed_unique.webp" alt="Unique 3.5% Recovery Skills" class="skill-icon d-s-none">
                <span class="skill-label">Unique 3.5% <span class="recovery-percent">(3.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Unique Recovery Skills 3.5%</strong><br><span>Restores 3.5% HP (+0.02% per level &gt; 1).<br>Examples:</span><ul>
                    <li>Introduction to Physiology</li>
                    <li>Super-Duper Stoked</li>
                    <li>Ready, Go!</li>
                    <li>Festive Miracle</li>
                </ul></div></span>
                <div class="stepper-group">
                    <select id="uniqueLvl35" class="recovery-level"></select>
                    <div class="stepper-group">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill35" data-step="-1">-</button>
                        <input type="text" id="uniqueSkill35" value="0" readonly class="skill-stepper-label">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill35" data-step="1">+</button>
                    </div>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_unique.webp" alt="Unique 5.5% Recovery Skills" class="skill-icon">
                <span class="skill-label">Unique 5.5% <span class="recovery-percent">(5.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Unique Recovery Skills 5.5%</strong><br><span>Restores 5.5% HP (+0.02% per level &gt; 1).<br>Examples:</span><ul>
                    <li>Clear Heart</li>
                    <li>U=ma2</li>
                    <li>Super-Duper Climax</li>
                    <li>Dazzl'n ♪ Diver</li>
                    <li>Every Rose Has Its Fangs</li>
                    <li>Go, Go, Mun!</li>
                    <li>Keep Pushing Ahead</li>
                </ul></div></span>
                <div class="stepper-group">
                    <select id="uniqueLvl55" class="recovery-level"></select>
                    <div class="stepper-group">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill55" data-step="-1">-</button>
                        <input type="text" id="uniqueSkill55" value="0" readonly class="skill-stepper-label">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill55" data-step="1">+</button>
                    </div>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_unique.webp" alt="Unique 7.5% Recovery Skills" class="skill-icon">
                <span class="skill-label">Unique 7.5% <span class="recovery-percent">(7.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Unique Recovery Skills 7.5%</strong><br><span>Restores 7.5% HP (+0.02% per level &gt; 1).<br>Examples:</span><ul>
                    <li>Pure Heart</li>
                    <li>Superior Heal</li>
                </ul></div></span>
                <div class="stepper-group">
                    <select id="uniqueLvl75" class="recovery-level"></select>
                    <div class="stepper-group">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill75" data-step="-1">-</button>
                        <input type="text" id="uniqueSkill75" value="0" readonly class="skill-stepper-label">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill75" data-step="1">+</button>
                    </div>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/recovery_unique.webp" alt="Unique 9.5% Recovery Skills" class="skill-icon">
                <span class="skill-label">Unique 9.5% <span class="recovery-percent">(9.5%)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Unique Recovery Skills 9.5%</strong><br><span>Restores 9.5% HP (+0.02% per level &gt; 1).<br>Currently, there are no skills in this category.</span></div></span>
                <div class="stepper-group">
                    <select id="uniqueLvl95" class="recovery-level"></select>
                    <div class="stepper-group">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill95" data-step="-1">-</button>
                        <input type="text" id="uniqueSkill95" value="0" readonly class="skill-stepper-label">
                        <button type="button" class="stepper-btn" data-target="uniqueSkill95" data-step="1">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="checkbox" id="section5" class="section-toggle">
    <label for="section5" class="section-label"><span class="section-title">5. Green Skills</span><span class="section-arrow"></span></label>
    <div class="section-content">
        <div class="skills-grid">
            <div class="skill-box">
                <img src="img/green_speed_gold.webp" alt="Gold and ◎ Speed Green Skills" class="skill-icon">
                <span class="skill-label">Gold and ◎ Speed <span class="bonus-value">(60)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Gold and ◎ Speed Skills</strong><br><span>Gold and ◎ green skills give 60 speed.<br>Examples:</span><ul>
                    <li>Right-Handed ◎</li>
                    <li>Left-Handed ◎</li>
                    <li>Spring Runner ◎</li>
                    <li>Summer Runner ◎</li>
                    <li>Fall Runner ◎</li>
                    <li>Winter Runner ◎</li>
                    <li>Unchanging</li>
                    <li>Fall Frenzy</li>
                    <li>Spring Spectacle</li>
                    <li>Right-Handed Demon</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="gSpeedGSkill" data-step="-1">-</button>
                    <input type="text" id="gSpeedGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="gSpeedGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_speed_normal.webp" alt="○ Speed Green Skills" class="skill-icon">
                <span class="skill-label">○ Speed <span class="bonus-value">(40)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>○ Speed Skills</strong><br><span>○ green skills give 40 speed.<br>Examples:</span><ul>
                    <li>Right-Handed ○</li>
                    <li>Left-Handed ○</li>
                    <li>Spring Runner ○</li>
                    <li>Summer Runner ○</li>
                    <li>Fall Runner ○</li>
                    <li>Winter Runner ○</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="nSpeedGSkill" data-step="-1">-</button>
                    <input type="text" id="nSpeedGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="nSpeedGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_stamina_gold.webp" alt="Gold and ◎ Stamina Green Skills" class="skill-icon">
                <span class="skill-label">Gold and ◎ Stamina <span class="bonus-value">(60)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Gold and ◎ Stamina Skills</strong><br><span>Gold and ◎ green skills give 60 stamina.<br>Examples:</span><ul>
                    <li>Standard Distance ◎</li>
                    <li>Tokyo Racecourse ◎</li>
                    <li>Yodo Invicta</li>
                    <li>For the Team</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="gStamGSkill" data-step="-1">-</button>
                    <input type="text" id="gStamGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="gStamGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_stamina_normal.webp" alt="○ Stamina Green Skills" class="skill-icon">
                <span class="skill-label">○ Stamina <span class="bonus-value">(40)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>○ Stamina Skills</strong><br><span>○ green skills give 40 stamina.<br>Examples:</span><ul>
                    <li>Standard Distance ○</li>
                    <li>Tokyo Racecourse ○</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="nStamGSkill" data-step="-1">-</button>
                    <input type="text" id="nStamGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="nStamGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_power_gold.webp" alt="Gold and ◎ Power Green Skills" class="skill-icon">
                <span class="skill-label">Gold and ◎ Power <span class="bonus-value">(60)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Gold and ◎ Power Skills</strong><br><span>Gold and ◎ green skills give 60 power.<br>Examples:</span><ul>
                    <li>Firm Conditions ◎</li>
                    <li>Wet Conditions ◎</li>
                    <li>Competitive Spirit ◎</li>
                    <li>Firm Course Menace</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="gPowerGSkill" data-step="-1">-</button>
                    <input type="text" id="gPowerGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="gPowerGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_power_normal.webp" alt="○ Power Green Skills" class="skill-icon">
                <span class="skill-label">○ Power <span class="bonus-value">(40)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>○ Power Skills</strong><br><span>○ green skills give 40 power.<br>Examples:</span><ul>
                    <li>Firm Conditions ○</li>
                    <li>Wet Conditions ○</li>
                    <li>Competitive Spirit ○</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="nPowerGSkill" data-step="-1">-</button>
                    <input type="text" id="nPowerGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="nPowerGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_guts_normal.webp" alt="◎ Guts Green Skills" class="skill-icon">
                <span class="skill-label">◎ Guts <span class="bonus-value">(60)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>◎ Guts Skills</strong><br><span>◎ green skills give 60 guts.<br>Examples:</span><ul>
                    <li>Sunny Days ◎</li>
                    <li>Cloudy Days ◎</li>
                    <li>Rainy Days ◎</li>
                    <li>Snowy Days ◎</li>
                    <li>Target in Sight ◎</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="gGutsGSkill" data-step="-1">-</button>
                    <input type="text" id="gGutsGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="gGutsGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_guts_normal.webp" alt="○ Guts Green Skills" class="skill-icon">
                <span class="skill-label">○ Guts <span class="bonus-value">(40)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>○ Guts Skills</strong><br><span>○ green skills give 40 guts.<br>Examples:</span><ul>
                    <li>Sunny Days ○</li>
                    <li>Cloudy Days ○</li>
                    <li>Rainy Days ○</li>
                    <li>Snowy Days ○</li>
                    <li>Target in Sight ○</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="nGutsGSkill" data-step="-1">-</button>
                    <input type="text" id="nGutsGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="nGutsGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_wit_gold.webp" alt="Gold and ◎ Wit Green Skills" class="skill-icon">
                <span class="skill-label">Gold and ◎ Wit <span class="bonus-value">(60)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>Gold and ◎ Wit Skills</strong><br><span>Gold and ◎ green skills give 60 wit.<br>Examples:</span><ul>
                    <li>Inner Post Proficiency ◎</li>
                    <li>Front Runner Savvy ◎</li>
                    <li>Pace Chaser Savvy ◎</li>
                    <li>Late Surger Savvy ◎</li>
                    <li>End Closer Savvy ◎</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="gWitGSkill" data-step="-1">-</button>
                    <input type="text" id="gWitGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="gWitGSkill" data-step="1">+</button>
                </div>
            </div>
            <div class="skill-box">
                <img src="img/green_wit_normal.webp" alt="○ Wit Green Skills" class="skill-icon">
                <span class="skill-label">○ Wit <span class="bonus-value">(40)</span><span class="skill-tooltip-icon">!</span><div class="skill-tooltip"><strong>○ Wit Skills</strong><br><span>○ green skills give 40 wit.<br>Examples:</span><ul>
                    <li>Inner Post Proficiency ○</li>
                    <li>Front Runner Savvy ○</li>
                    <li>Pace Chaser Savvy ○</li>
                    <li>Late Surger Savvy ○</li>
                    <li>End Closer Savvy ○</li>
                </ul></div></span>
                <div class="stepper-group">
                    <button type="button" class="stepper-btn" data-target="nWitGSkill" data-step="-1">-</button>
                    <input type="text" id="nWitGSkill" value="0" readonly class="skill-stepper-label">
                    <button type="button" class="stepper-btn" data-target="nWitGSkill" data-step="1">+</button>
                </div>
            </div>
        </div>
    </div>

    <div class="calculated-stats-area">
        <div class="text-center">Calculated stats</div>
        <div class="calculated-stats-row">
            <div>
                <div class="stat-label">Speed</div>
                <img src="img/speed.webp" alt="Speed">
                <div id="stat-adjSpd" class="stat-value">-</div>
            </div>
            <div>
                <div class="stat-label">Stamina</div>
                <img src="img/stamina.webp" alt="Stamina">
                <div id="stat-adjStam" class="stat-value">-</div>
            </div>
            <div>
                <div class="stat-label">Power</div>
                <img src="img/power.webp" alt="Power">
                <div id="stat-adjPwr" class="stat-value">-</div>
            </div>
            <div>
                <div class="stat-label">Guts</div>
                <img src="img/guts.webp" alt="Guts">
                <div id="stat-adjGuts" class="stat-value">-</div>
            </div>
            <div>
                <div class="stat-label">Wit</div>
                <img src="img/wit.webp" alt="Wit">
                <div id="stat-adjWit" class="stat-value">-</div>
            </div>
        </div>
    </div>

    <div class="results-area">
        <div class="res-grid">
            <div class="res-box">
                <div class="tooltip"><h3>TOTAL HP</h3><span class="tooltiptext" id="tip-hp"></span></div>
                <span class="res-val" id="res-hp">0</span>
            </div>
            <div class="res-box">
                <div class="tooltip"><h3>HP CONSUMPTION</h3><span class="tooltiptext" id="tip-cons"></span></div>
                <span class="res-val" id="res-cons" style="color: #fab1a0;">0</span>
            </div>
            <div class="res-box">
                <div class="tooltip"><h3>VERDICT</h3><span class="tooltiptext" id="tip-status"></span></div>
                <span class="res-val" id="res-status">-</span>
            </div>
        </div>
        <div class="target-container">
            <div class="tooltip"><h3>REQUIRED STAMINA STAT</h3><span class="tooltiptext" id="tip-target"></span></div>
            <span class="target-val" id="res-target">0</span>
        </div>
    </div>

    <footer class="footer">
        Umamusume Stamina Calculator - Global.<br>
        All formulas are taken from <a href="https://docs.google.com/spreadsheets/d/17cFLj_L2Qy9vNf2x0Cm7QnakEoxcbsWnRIxrOGqfPBQ/edit?gid=0#gid=0" target="_blank" rel="noopener">this spreadsheet</a>.<br>
        Source code: <a href="https://github.com/FedericoHeichou/umamusume-stamina-calculator-global" target="_blank" rel="noopener">GitHub Repository</a>.
    </footer>
</div>

<script>
/**
 * CONFIG OBJECT
 * All coefficients are mapped here from the "定義" sheet in the original spreadsheet.
 */
const CONFIG = {
    AptTrack: { 'S': 1.05, 'A': 1.0, 'B': 0.9, 'C': 0.8, 'D': 0.7, 'E': 0.5, 'F': 0.3, 'G': 0.1 },
    AptDist: {
        'S': { speed: 1.05, accel: 1.0 }, 'A': { speed: 1.0, accel: 1.0 },
        'B': { speed: 0.9, accel: 1.0 }, 'C': { speed: 0.8, accel: 1.0 },
        'D': { speed: 0.6, accel: 1.0 }, 'E': { speed: 0.4, accel: 0.6 },
        'F': { speed: 0.2, accel: 0.5 }, 'G': { speed: 0.1, accel: 0.4 }
    },
    AptStyle: { 'S': 1.1, 'A': 1.0, 'B': 0.85, 'C': 0.75, 'D': 0.6, 'E': 0.4, 'F': 0.2, 'G': 0.1 },
    RunningStyles: {
        'Front Runner': { hp: 0.95, speed: [1.0, 0.98, 0.962], accel: [1.0, 1.0, 0.996] },
        'Pace Chaser':  { hp: 0.89, speed: [0.978, 0.991, 0.975], accel: [0.985, 1.0, 0.996] },
        'Late Surger':  { hp: 1.0,  speed: [0.938, 0.998, 0.994], accel: [0.975, 1.0, 1.0] },
        'End Closer':   { hp: 0.995, speed: [0.931, 1.0, 1.0], accel: [0.945, 1.0, 0.997] }
    },
    TrackConditions: {
        'Turf': {
            'Firm':  { spd: 0, pwr: 0, cons: 1.0 },
            'Good':  { spd: 0, pwr: -50, cons: 1.0 },
            'Soft':  { spd: 0, pwr: -50, cons: 1.02 },
            'Heavy': { spd: -50, pwr: -50, cons: 1.02 }
        },
        'Dirt': {
            'Firm':  { spd: 0, pwr: -100, cons: 1.0 },
            'Good':  { spd: 0, pwr: -50, cons: 1.0 },
            'Soft':  { spd: 0, pwr: -100, cons: 1.01 },
            'Heavy': { spd: -50, pwr: -100, cons: 1.02 }
        }
    },
    Mood: { 'Very Good': 1.04, 'Good': 1.02, 'Normal': 1.0, 'Bad': 0.98, 'Very Bad': 0.96 },
    UniqueRecovery: { 'Lvl 1': 0, 'Lvl 2': 0.02, 'Lvl 3': 0.04, 'Lvl 4': 0.06, 'Lvl 5': 0.08 }
};

function syncRankColor(el) {
    el.setAttribute('data-rank', el.value);
}

// Initialize HTML Selects based on CONFIG
function init() {
    const populate = (id, data) => {
        const sel = document.getElementById(id);
        if (!sel) return; // Safety: if the ID does not exist
        const isApt = id.startsWith('apt');
        Object.keys(data).forEach(k => {
            const opt = new Option(k, k);
            if (isApt) opt.setAttribute('data-rank', k);
            sel.add(opt);
        });

        if (isApt) {
            sel.addEventListener('change', () => syncRankColor(sel));
            syncRankColor(sel);
        }
    };

    // 1. Initial population of all static selects
    populate('surface', CONFIG.TrackConditions);
    populate('mood', CONFIG.Mood);
    populate('aptTrack', CONFIG.AptTrack);
    populate('aptDist', CONFIG.AptDist);
    populate('aptStyle', CONFIG.AptStyle);
    populate('style', CONFIG.RunningStyles);
    populate('uniqueLvl15', CONFIG.UniqueRecovery);
    populate('uniqueLvl35', CONFIG.UniqueRecovery);
    populate('uniqueLvl55', CONFIG.UniqueRecovery);
    populate('uniqueLvl75', CONFIG.UniqueRecovery);
    populate('uniqueLvl95', CONFIG.UniqueRecovery);

    // 2. Logic for the dynamic select (Condition)
    const surfaceEl = document.getElementById('surface');
    surfaceEl.onchange = () => {
        const condSel = document.getElementById('condition');
        condSel.innerHTML = "";
        const surf = surfaceEl.value;
        if (CONFIG.TrackConditions[surf]) {
            Object.keys(CONFIG.TrackConditions[surf]).forEach(k => condSel.add(new Option(k, k)));
        }
        // If we just loaded the surface from saved state,
        // we must also set the condition after populating
        if (window._loadingState && window._loadingState.condition) {
            condSel.value = window._loadingState.condition;
        }
        calc();
    };

    // 3. LOAD STATE (Default or LocalStorage)
    const savedState = JSON.parse(localStorage.getItem('inputState'));

    if (savedState) {
        // Use a temporary global variable at load to handle dependencies
        window._loadingState = savedState;

        // Disable all transitions during load to prevent jank
        const allSections = document.querySelectorAll('.section-content');
        allSections.forEach(el => el.classList.add('no-transition'));

        Object.keys(savedState).forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = savedState[id];
                } else {
                    el.value = savedState[id];
                    if (id.startsWith('apt')) syncRankColor(el);
                }
            }
        });

        // Restore transitions
        setTimeout(() => allSections.forEach(el => el.classList.remove('no-transition')), 100);
    } else {
        // Defaults if nothing in localStorage
        const defaults = ['aptTrack', 'aptDist', 'aptStyle'];
        defaults.forEach(id => {
            const el = document.getElementById(id);
            el.value = 'A';
            syncRankColor(el);
        });
        document.getElementById('mood').value = 'Normal';
        document.getElementById('uniqueLvl35').value = 'Lvl 1';
        document.getElementById('uniqueLvl55').value = 'Lvl 1';
    }

    // 4. Manual trigger of surface to populate 'condition'
    surfaceEl.dispatchEvent(new Event('change'));

    // Cleanup
    delete window._loadingState;

    // Add events to all inputs to trigger calculation on change
    document.querySelectorAll('input').forEach(input => input.addEventListener('input', calc));
    document.querySelectorAll('select').forEach(select => select.addEventListener('change', calc));
    // Add events to steppers
    document.querySelectorAll('.stepper-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = document.getElementById(this.dataset.target);
            let val = parseInt(target.value) || 0;
            val += parseInt(this.dataset.step);
            if (val < 0) val = 0;
            target.value = val;
            target.dispatchEvent(new Event('input', {bubbles:true}));
        });
    });

    calc();
}

function calc() {
    // Inputs
    const speedBase         = parseFloat(document.getElementById('speed').value) || 0;
    const stamBase          = parseFloat(document.getElementById('stam').value) || 0;
    const pwrBase           = parseFloat(document.getElementById('power').value) || 0;
    const gutsBase          = parseFloat(document.getElementById('guts').value) || 0;
    const witBase           = parseFloat(document.getElementById('wit').value) || 0;
    const dist              = parseFloat(document.getElementById('dist').value) || 0;

    const surf              = document.getElementById('surface').value;
    const cond              = document.getElementById('condition').value;
    const mood              = document.getElementById('mood').value;
    const moodVal           = CONFIG.Mood[mood];

    const aptTrack          = document.getElementById('aptTrack').value;
    const trackApt          = CONFIG.AptTrack[aptTrack];
    const aptDist           = document.getElementById('aptDist').value;
    const distApt           = CONFIG.AptDist[aptDist];
    const aptStyle          = document.getElementById('aptStyle').value;
    const styleApt          = CONFIG.AptStyle[aptStyle];
    const styleName         = document.getElementById('style').value;
    const styleData         = CONFIG.RunningStyles[styleName];

    const goldR              = parseInt(document.getElementById('goldRecoverySkill').value) || 0;
    const whiteR             = parseInt(document.getElementById('whiteRecoverySkill').value) || 0;
    const unique15          = parseInt(document.getElementById('uniqueSkill15').value) || 0;
    const uniqueLvl15Key    = document.getElementById('uniqueLvl15').value;
    const uniqueLvl15       = CONFIG.UniqueRecovery[uniqueLvl15Key];
    const unique35          = parseInt(document.getElementById('uniqueSkill35').value) || 0;
    const uniqueLvl35Key    = document.getElementById('uniqueLvl35').value;
    const uniqueLvl35       = CONFIG.UniqueRecovery[uniqueLvl35Key];
    const unique55          = parseInt(document.getElementById('uniqueSkill55').value) || 0;
    const uniqueLvl55Key    = document.getElementById('uniqueLvl55').value;
    const uniqueLvl55       = CONFIG.UniqueRecovery[uniqueLvl55Key];
    const unique75          = parseInt(document.getElementById('uniqueSkill75').value) || 0;
    const uniqueLvl75Key    = document.getElementById('uniqueLvl75').value;
    const uniqueLvl75       = CONFIG.UniqueRecovery[uniqueLvl75Key];
    const unique95          = parseInt(document.getElementById('uniqueSkill95').value) || 0;
    const uniqueLvl95Key    = document.getElementById('uniqueLvl95').value;
    const uniqueLvl95       = CONFIG.UniqueRecovery[uniqueLvl95Key];

    const goldSpeedG        = (parseInt(document.getElementById('gSpeedGSkill').value) || 0) * 60;
    const whiteSpeedG       = (parseInt(document.getElementById('nSpeedGSkill').value) || 0) * 40;
    const goldStamG         = (parseInt(document.getElementById('gStamGSkill').value) || 0) * 60;
    const whiteStamG        = (parseInt(document.getElementById('nStamGSkill').value) || 0) * 40;
    const goldPwrG          = (parseInt(document.getElementById('gPowerGSkill').value) || 0) * 60;
    const whitePwrG         = (parseInt(document.getElementById('nPowerGSkill').value) || 0) * 40;
    const goldGutsG         = (parseInt(document.getElementById('gGutsGSkill').value) || 0) * 60;
    const whiteGutsG        = (parseInt(document.getElementById('nGutsGSkill').value) || 0) * 40;
    const goldWitG          = (parseInt(document.getElementById('gWitGSkill').value) || 0) * 60;
    const whiteWitG         = (parseInt(document.getElementById('nWitGSkill').value) || 0) * 40;

    // Save all the inputs in the localStorage as json
    const inputs = document.querySelectorAll('input, select');
    const state = {};
    inputs.forEach(el => { if(el.id) state[el.id] = el.type === 'checkbox' ? el.checked : el.value; });
    localStorage.setItem('inputState', JSON.stringify(state));

    // Constants
    const paceDownChangeAssumption = 0.05;
    const goldRecovery = 0.055;
    const whiteRecovery = 0.015;
    const unique15Recovery = 0.015;
    const unique35Recovery = 0.035;
    const unique55Recovery = 0.055;
    const unique75Recovery = 0.075;
    const unique95Recovery = 0.095;
    // Formules
    // 1. STAT MODIFIERS (Surface/Condition)
    const condMods = CONFIG.TrackConditions[surf][cond];
    const adjSpd = (speedBase + goldSpeedG + whiteSpeedG + condMods.spd) * distApt.speed * moodVal;
    const adjStam = stamBase + goldStamG + whiteStamG;
    const adjPwr = (pwrBase + goldPwrG + whitePwrG + condMods.pwr) * trackApt * moodVal;
    const adjGuts = gutsBase + goldGutsG + whiteGutsG;
    const adjWit = witBase + goldWitG + whiteWitG;

    // 2. HP CALCULATIONS
    const baseSpeed = 20 - (dist - 2000) / 1000;  // in m/s
    const baseHP = dist + 0.8 * adjStam * styleData.hp;
    const unique15RecoveryBonus = 1 + uniqueLvl15;
    const unique35RecoveryBonus = 1 + uniqueLvl35;
    const unique55RecoveryBonus = 1 + uniqueLvl55;
    const unique75RecoveryBonus = 1 + uniqueLvl75;
    const unique95RecoveryBonus = 1 + uniqueLvl95;
    const recoveryStdSkillRate = (goldR * goldRecovery) + (whiteR * whiteRecovery);
    const recoveryUniqueRate = (unique15 * (unique15Recovery * unique15RecoveryBonus)) + (unique35 * (unique35Recovery * unique35RecoveryBonus)) + (unique55 * (unique55Recovery * unique55RecoveryBonus)) + (unique75 * (unique75Recovery * unique75RecoveryBonus)) + (unique95 * (unique95Recovery * unique95RecoveryBonus));
    const recoveryRate = recoveryStdSkillRate + recoveryUniqueRate;
    const totalHP = baseHP * (1 + recoveryRate);

    const consumptionTrackFactor = CONFIG.TrackConditions[surf][cond].cons;
    const consumptionLastSpurtFactor = 1 + (200 / Math.sqrt(600*adjGuts));

    function calcTopSpeed(speedCoeff) {
        return baseSpeed * speedCoeff + ((adjWit/5500) * Math.log10(adjWit*0.1) - 0.65 / 2) * 0.01 * baseSpeed;
    }

    const midLegTopSpeedBeforeModes = calcTopSpeed(styleData.speed[1]);
    const nonNormalModeUptime = (dist / 24 / midLegTopSpeedBeforeModes) / (dist / 24 / midLegTopSpeedBeforeModes + 3);

    function calcTargetSpeedFromPhase(phaseId) {
        const speedCoeff = styleData.speed[Math.min(phaseId, 2)];
        if (phaseId == 0) {
            return calcTopSpeed(speedCoeff);
        }
        if (phaseId === 1) {
            const styleCoeff = styleName !== 'Front Runner' ? -0.055*paceDownChangeAssumption : 0.04 * 0.2 * Math.log10(adjWit * 0.1);
            return midLegTopSpeedBeforeModes * (1 + nonNormalModeUptime * styleCoeff)
        }
        if (phaseId === 2) {
            return baseSpeed * speedCoeff + Math.sqrt(500 * adjSpd) * distApt.speed * trackApt * 0.002 + ((adjWit/5500) * Math.log10(adjWit*0.1) - 0.65 / 2) * 0.01 * baseSpeed;
        }
        const lastSpurtBase = (baseSpeed * (speedCoeff + 0.01) + Math.sqrt(500 * adjSpd) * distApt.speed * trackApt * 0.002);
        return lastSpurtBase * 1.05 + Math.sqrt(500 * adjSpd) * distApt.speed * trackApt * 0.002;
    }

    function calcAccelerationFromPhase(phaseId) {
        return 0.0006 * Math.sqrt(500 * adjPwr) * styleData.accel[Math.min(phaseId, 2)] * distApt.accel * trackApt;
    }

    function calcTime(initialSpeed, targetSpeed, acceleration) {
        return (targetSpeed - initialSpeed) / acceleration;
    }

    function calcHPConsumption(initialSpeed, acceleration, time, isConstant, isLastSpurt, forceTargetSpeed=0) {
        const consumptionFactor = isLastSpurt ? consumptionTrackFactor * consumptionLastSpurtFactor : consumptionTrackFactor;
        const targetSpeed = forceTargetSpeed || initialSpeed + acceleration * time;
        if (isConstant) {
            return 20 * consumptionFactor * (targetSpeed - baseSpeed + 12) ** 2 / 144 * time;
        }
        return 20 * consumptionFactor * ((targetSpeed - baseSpeed + 12) ** 3 - (initialSpeed - baseSpeed + 12) ** 3) / (3 * acceleration) / 144;
    }

    const raceMatrix = {};
    // Start Dash
    let initialSpeed = 3.0;
    let targetSpeed = baseSpeed * 0.85;
    let acceleration = 24 + calcAccelerationFromPhase(0);
    let time = calcTime(initialSpeed, targetSpeed, acceleration);
    let distance = (initialSpeed + targetSpeed) / 2 * time;
    let hpConsumption = 20 * consumptionTrackFactor * time;
    raceMatrix.startDash = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 0
    initialSpeed = raceMatrix.startDash.targetSpeed;
    targetSpeed = calcTargetSpeedFromPhase(0);
    acceleration = calcAccelerationFromPhase(0);
    time = Math.min(calcTime(initialSpeed, targetSpeed, acceleration), (-initialSpeed + Math.sqrt(initialSpeed**2 + 2 * acceleration * (dist / 6 - distance))) / acceleration);
    distance = (initialSpeed + acceleration * time / 2) * time;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, false, false);
    raceMatrix.phase0 = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 0 Constant
    initialSpeed = raceMatrix.phase0.targetSpeed;
    targetSpeed = raceMatrix.phase0.targetSpeed;
    acceleration = 0;
    distance = Math.max(dist / 6 - (raceMatrix.startDash.distance + raceMatrix.phase0.distance), 0);
    time = distance / targetSpeed;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, true, false);
    raceMatrix.phase0Constant = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 1
    initialSpeed = initialSpeed + acceleration * time;
    targetSpeed = calcTargetSpeedFromPhase(1);
    acceleration = initialSpeed <= targetSpeed ? calcAccelerationFromPhase(1) : -0.8;
    time = calcTime(initialSpeed, targetSpeed, acceleration);
    distance = (initialSpeed + targetSpeed) / 2 * time;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, false, false);
    raceMatrix.phase1 = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 1 Constant
    initialSpeed = raceMatrix.phase1.targetSpeed;
    targetSpeed = raceMatrix.phase1.targetSpeed;
    acceleration = 0;
    distance = dist / 2 - raceMatrix.phase1.distance;
    time = distance / targetSpeed;
    // Rushing rate should be calculated only if needed (on or off), but we don't care, so we assume it is always off (0)
    const rushingRate = 0;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, true, false) * (1 + rushingRate * (3*0.55+6*0.45*0.55+9*0.45**2*0.55+12*0.45**3)/time * 0.6);
    if (styleName !== "Front Runner") {
        hpConsumption *= (1 - 0.4 * paceDownChangeAssumption * nonNormalModeUptime);
    }
    raceMatrix.phase1Constant = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 2
    initialSpeed = raceMatrix.phase1Constant.targetSpeed;
    targetSpeed = calcTargetSpeedFromPhase(2);
    const lastSpurtTargetSpeed = calcTargetSpeedFromPhase(3);
    acceleration = initialSpeed <= targetSpeed ? calcAccelerationFromPhase(2) : -0.8;
    const currentConsumedHP = Object.values(raceMatrix).reduce((sum, phase) => sum + phase.hpConsumption, 0);
    const lastSpurtStartDistance = Math.min((totalHP - currentConsumedHP - (dist / 3 - 60) * 20 * consumptionTrackFactor * consumptionLastSpurtFactor * (targetSpeed - baseSpeed + 12) ** 2 / 144 / targetSpeed) / (20 * consumptionTrackFactor * consumptionLastSpurtFactor * ((lastSpurtTargetSpeed - baseSpeed + 12) ** 2 / 144 / lastSpurtTargetSpeed - (targetSpeed - baseSpeed + 12) ** 2 / 144 / targetSpeed)) + 60, dist / 3);
    time = dist / 3 <= lastSpurtStartDistance ? 0 : (targetSpeed - initialSpeed) / acceleration;
    distance = (initialSpeed + targetSpeed) / 2 * time;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, false, true);
    raceMatrix.phase2 = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Phase 2, 3 Constant
    initialSpeed = raceMatrix.phase2.targetSpeed;
    targetSpeed = raceMatrix.phase2.targetSpeed;
    acceleration = 0;
    distance = Math.max(dist / 3 - lastSpurtStartDistance - raceMatrix.phase2.distance, 0);
    time = distance / targetSpeed;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, true, true);
    raceMatrix.phase2Constant = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Last Spurt
    initialSpeed = raceMatrix.phase2.distance ? raceMatrix.phase2Constant.targetSpeed : raceMatrix.phase1Constant.targetSpeed;
    targetSpeed = calcTargetSpeedFromPhase(3);
    acceleration = calcAccelerationFromPhase(3);
    time = calcTime(initialSpeed, targetSpeed, acceleration);
    distance = (initialSpeed + targetSpeed) / 2 * time;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, false, true);
    raceMatrix.lastSpurt = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Last Spurt Constant
    initialSpeed = raceMatrix.lastSpurt.targetSpeed;
    targetSpeed = raceMatrix.lastSpurt.targetSpeed;
    acceleration = 0;
    hpConsumption = Math.min(calcHPConsumption(initialSpeed, acceleration, (dist/3 - (raceMatrix.phase2.distance + raceMatrix.phase2Constant.distance + raceMatrix.lastSpurt.distance)), true, true, targetSpeed) / initialSpeed, totalHP - Object.values(raceMatrix).reduce((sum, phase) => sum + phase.hpConsumption, 0));
    time = hpConsumption / calcHPConsumption(initialSpeed, acceleration, 1, true, true, targetSpeed);
    distance = targetSpeed * time;
    raceMatrix.lastSpurtConstant = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // HP 0 (deceleration)
    initialSpeed = raceMatrix.lastSpurtConstant.targetSpeed;
    targetSpeed = 0;
    acceleration = -1.2;
    distance = dist / 3 - (raceMatrix.phase2.distance + raceMatrix.phase2Constant.distance + raceMatrix.lastSpurt.distance + raceMatrix.lastSpurtConstant.distance);
    time = (-initialSpeed + Math.sqrt(initialSpeed**2 + 2 * acceleration * distance)) / acceleration;
    hpConsumption = 0;
    raceMatrix.hp0Deceleration = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };

    // Ideal consumption
    initialSpeed = raceMatrix.phase1Constant.targetSpeed;
    targetSpeed = raceMatrix.lastSpurtConstant.targetSpeed;
    acceleration = raceMatrix.lastSpurt.acceleration;
    time = calcTime(initialSpeed, targetSpeed, acceleration);
    distance = (initialSpeed + targetSpeed) / 2 * time;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, false, true);
    raceMatrix.idealConsumption = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    // Ideal consumption constant
    initialSpeed = raceMatrix.idealConsumption.targetSpeed;
    targetSpeed = raceMatrix.idealConsumption.targetSpeed;
    acceleration = 0;
    distance = dist / 3 - raceMatrix.idealConsumption.distance;
    time = distance / targetSpeed;
    hpConsumption = calcHPConsumption(initialSpeed, acceleration, time, true, true, targetSpeed);
    raceMatrix.idealConsumptionConstant = {
        initialSpeed: initialSpeed,
        targetSpeed: targetSpeed,
        acceleration: acceleration,
        time: time,
        distance: distance,
        hpConsumption: hpConsumption,
    };
    const consumption = (
        raceMatrix.startDash.hpConsumption +
        raceMatrix.phase0.hpConsumption +
        raceMatrix.phase0Constant.hpConsumption +
        raceMatrix.phase1.hpConsumption +
        raceMatrix.phase1Constant.hpConsumption +
        raceMatrix.idealConsumption.hpConsumption +
        raceMatrix.idealConsumptionConstant.hpConsumption
    );
    const targetStamina = adjStam + (consumption - totalHP) / 0.8 / styleData.hp / (1 + recoveryRate);

    // Update UI
    document.getElementById('stat-adjSpd').innerText = Math.ceil(adjSpd);
    document.getElementById('stat-adjStam').innerText = Math.ceil(adjStam);
    document.getElementById('stat-adjPwr').innerText = Math.ceil(adjPwr);
    document.getElementById('stat-adjGuts').innerText = Math.ceil(adjGuts);
    document.getElementById('stat-adjWit').innerText = Math.ceil(adjWit);

    document.getElementById('res-hp').innerText = totalHP.toFixed(2);
    document.getElementById('res-cons').innerText = consumption.toFixed(2);
    document.getElementById('res-target').innerText = Math.ceil(targetStamina);

    const status = document.getElementById('res-status');
    status.innerText = totalHP >= consumption ? "Enough ✅" : "Not Enough ❌";
    status.style.color = totalHP >= consumption ? "#2ecc71" : "#ff7675";

    // Update Tooltips
    document.getElementById('tip-hp').innerText =
        `Base HP = Distance + 0.8 × Stamina × Style HP Mod\n` +
        `Formula: baseHP = ${dist} + 0.8 × ${adjStam} × ${styleData.hp.toFixed(3)} = ${baseHP.toFixed(2)}\n` +
        `Recovery: (${goldR} × ${(goldRecovery*100).toFixed(1)}%) + (${whiteR} × ${(whiteRecovery*100).toFixed(1)}%) + (${unique15} × ${((unique15Recovery*unique15RecoveryBonus)*100).toFixed(2)}%) + (${unique35} × ${((unique35Recovery*unique35RecoveryBonus)*100).toFixed(2)}%) + (${unique55} × ${((unique55Recovery*unique55RecoveryBonus)*100).toFixed(2)}%) + (${unique75} × ${((unique75Recovery*unique75RecoveryBonus)*100).toFixed(2)}%) + (${unique95} × ${((unique95Recovery*unique95RecoveryBonus)*100).toFixed(2)}%) = ${(recoveryRate*100).toFixed(2)}%\n` +
        `Total HP = baseHP × Recovery% = ${baseHP.toFixed(2)} × ${(100+recoveryRate*100).toFixed(2)}% = ${totalHP.toFixed(2)}`;

    document.getElementById('tip-cons').innerText =
        `HP Consumption is calculated by summing the HP used in each race phase (see code for details).\n` +
        `Track Factor: ${consumptionTrackFactor}\n` +
        `Last Spurt Factor: ${consumptionLastSpurtFactor.toFixed(3)}\n` +
        `Adjusted Power: ${adjPwr.toFixed(2)}, Adjusted Speed: ${adjSpd.toFixed(2)}\n` +
        `Total Consumption = sum of all phase consumptions = ${consumption.toFixed(2)}`;

    document.getElementById('tip-status').innerText =
        totalHP >= consumption ?
        `You have enough Stamina/Guts` :
        `You do NOT have enough Stamina/Guts`;

    document.getElementById('tip-target').innerText =
        `Required Stamina = Current Stamina + (Consumption - Total HP) / (0.8 × Style HP Mod × Recovery%)\n` +
        `Formula: ${adjStam} + (${consumption.toFixed(2)} - ${totalHP.toFixed(2)}) / (0.8 × ${styleData.hp.toFixed(2)} × ${(100+recoveryRate*100).toFixed(2)}%) = ${Math.ceil(targetStamina)}`;
}

window.onload = init;
</script>
</body>
</html>
